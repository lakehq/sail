syntax = "proto3";

package sail.plan;

// All DataFusion data structures are represented as opaque bytes.
// The encoding and decoding of these data structures are handled
// in the code.
// We do not explicitly use the DataFusion message types since there may be
// breaking changes across DataFusion versions, and it is difficult to
// keep the proto definitions in sync with the DataFusion proto crate.

message ExtendedPhysicalPlanNode {
  oneof NodeKind {
    RangeExecNode range = 1;
    ShowStringExecNode show_string = 2;
    ShuffleReadExecNode shuffle_read = 3;
    ShuffleWriteExecNode shuffle_write = 4;
    // TODO: This can be removed once it is supported by DataFusion.
    MemoryExecNode memory = 101;
  }
}

message RangeExecNode {
  int64 start = 1;
  int64 end = 2;
  int64 step = 3;
  uint64 num_partitions = 4;
  bytes schema = 5;
}

message ShowStringExecNode {
  bytes input = 1;
  repeated string names = 2;
  uint64 limit = 3;
  ShowStringStyle style = 4;
  uint64 truncate = 5;
  bytes schema = 6;
}

enum ShowStringStyle {
  SHOW_STRING_STYLE_DEFAULT = 0;
  SHOW_STRING_STYLE_VERTICAL = 1;
  SHOW_STRING_STYLE_HTML = 2;
}

message MemoryExecNode {
  repeated bytes partitions = 1;
  bytes schema = 2;
  optional PhysicalProjection projection = 3;
  // TODO: `sort_information` and `show_sizes` are missing
  //   since there is no getter for them in the node.
}

message PhysicalProjection {
  repeated uint64 columns = 1;
}

message ShuffleReadExecNode {
  uint64 job_id = 1;
  uint64 stage = 2;
  bytes schema = 3;
  bytes partitioning = 4;
  repeated ShuffleReadLocationList locations = 5;
}

message ShuffleReadLocationList {
  repeated ShuffleReadLocation locations = 1;
}

message ShuffleReadLocation {
  oneof Location {
    ShuffleReadLocationThisWorker this_worker = 1;
    ShuffleReadLocationOtherWorker other_worker = 2;
    ShuffleReadLocationRemote remote = 3;
  }
}

message ShuffleReadLocationThisWorker {
  string channel = 1;
}

message ShuffleReadLocationOtherWorker {
  string host = 1;
  uint32 port = 2;
  string channel = 3;
}

message ShuffleReadLocationRemote {
  string uri = 1;
}

message ShuffleWriteExecNode {
  uint64 job_id = 1;
  uint64 stage = 2;
  bytes plan = 3;
  bytes partitioning = 4;
  repeated ShuffleWriteLocationList locations = 5;
}

message ShuffleWriteLocationList {
  repeated ShuffleWriteLocation locations = 1;
}

message ShuffleWriteLocation {
  oneof Location {
    ShuffleWriteLocationMemory memory = 1;
    ShuffleWriteLocationDisk disk = 2;
    ShuffleWriteLocationRemote remote = 3;
  }
}

message ShuffleWriteLocationMemory {
  string channel = 1;
}

message ShuffleWriteLocationDisk {
  string channel = 1;
}

message ShuffleWriteLocationRemote {
  string uri = 1;
}
