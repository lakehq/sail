name: Build Docs

on:
  pull_request:
    branches: [main]
    # Only trigger this flow if only docs related files have been updated
    # If also other files have been updated then run the normal build flow
    paths:
      - "docs/"
      - "*.js"
      - "*.json"
      - "pnpm-lock.yaml"
      - "!README.md"
      - "!crates/**"
      - "!docker/**"
      - "!k8s/**"
      - "!python/**"
    types:
      - labeled
      - opened
      - reopened
      - synchronize

jobs:
  setup:
    name: Setup
    runs-on: ubuntu-latest
    outputs:
      package_run_id: ${{ steps.baseline-workflow.outputs.workflow_run_id }}
    steps:
      - uses: actions/checkout@v4

      - uses: ./.github/actions/commit-baseline
        id: baseline

      - uses: ./.github/actions/commit-workflow
        id: baseline-workflow
        with:
          sha: ${{ steps.baseline.outputs.sha }}
          workflow_name: Build
          artifact_name: python-package

  docs-build:
    name: Docs Build
    uses: ./.github/workflows/docs-build.yml
    strategy:
      matrix:
        stage: ${{ fromJSON(github.event_name == 'push' && '["dev", "prod"]' || '["test"]') }}
    needs:
      - setup
    with:
      stage: ${{ matrix.stage }}
      version: main
      package_run_id: ${{ needs.setup.outputs.package_run_id }}
