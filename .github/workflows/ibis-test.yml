name: Ibis Tests

on:
  workflow_call:
    inputs:
      spark_version:
        description: Spark version to use
        type: string
        default: "4.0.0"

jobs:
  setup:
    name: Setup
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: "corretto"
          java-version: "17"

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Hatch
        uses: pypa/hatch@install

      - name: Install Rust toolchain
        run: |
          rustup toolchain install stable

      - name: Build native extension (editable)
        run: |
          hatch run maturin develop
          hatch run maturin build

      - name: Install grpc_health_probe
        run: |
          wget -q -O /usr/local/bin/grpc_health_probe "https://github.com/grpc-ecosystem/grpc-health-probe/releases/download/v0.4.26/grpc_health_probe-linux-amd64"
          chmod +x /usr/local/bin/grpc_health_probe
          grpc_health_probe -version

      - name: Run Spark Connect Server
        run: |
          nohup hatch run test-ibis:scripts/spark-tests/run-server.sh > /dev/null 2>&1 &

      - name: Wait for Spark Connect Server to Start
        run: |
          scripts/spark-tests/wait-for-server.sh

      - name: Run Ibis Tests
        timeout-minutes: 5
        env:
          SPARK_REMOTE: "sc://localhost:50051"
        run: |
          hatch run -e test-ibis scripts/spark-tests/run-tests.sh

      - name: Shutdown Spark Connect Server
        if: always()
        run: |
          SAIL_PIDS=$(pgrep -f "sail spark server" || echo "")
          if [ -n "$SAIL_PIDS" ]; then
            echo "Found sail server processes: $SAIL_PIDS"
            kill -INT $SAIL_PIDS 2>/dev/null || true
            for i in {1..30}; do
              if ! pgrep -f "sail spark server" > /dev/null; then
                echo "Sail server stopped gracefully"
                break
              fi
              sleep 1
            done
            REMAINING_PIDS=$(pgrep -f "sail spark server" || echo "")
            if [ -n "$REMAINING_PIDS" ]; then
              echo "Force killing remaining processes: $REMAINING_PIDS"
              kill -KILL $REMAINING_PIDS 2>/dev/null || true
            fi
          else
            echo "No sail server processes found"
          fi
          sleep 5
