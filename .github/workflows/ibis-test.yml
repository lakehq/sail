name: Ibis Tests
on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    env:
      SPARK_REMOTE: "sc://localhost:50051"
      SPARK_VERSION: "4.0.0"
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: "corretto"
          java-version: "17"

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Hatch
        uses: pypa/hatch@install

      - name: Install Rust toolchain and coverage tools
        run: |
          {
            rustup toolchain install stable
          } &

      - name: Install protoc
        uses: arduino/setup-protoc@v3
        with:
          version: "23.x"

      - name: Build Python Package
        uses: PyO3/maturin-action@v1

      - name: Build and install
        run: |
          hatch run maturin develop
          hatch run maturin build

      - name: Install grpc_health_probe
        run: |
          wget -q -O /usr/local/bin/grpc_health_probe "https://github.com/grpc-ecosystem/grpc-health-probe/releases/download/v0.4.26/grpc_health_probe-linux-amd64"
          chmod +x /usr/local/bin/grpc_health_probe
          grpc_health_probe -version

#      - name: Start Spark Connect server
#        run: |
#          nohup hatch run test-ibis:scripts/spark-tests/run-server.sh > /dev/null 2>&1 < /dev/null &
      - name: Start Spark Connect server (live log)
        run: |
          set -e
          mkdir -p tmp/spark-tests/latest
          ( stdbuf -oL -eL hatch run test-ibis:scripts/spark-tests/run-server.sh \
              2>&1 | tee tmp/spark-tests/latest/server.log ) &
          
          sleep 3
          if ! pgrep -f "sail spark server" >/dev/null; then
            echo "âŒ Server process not found right after launch."
            exit 1
          fi


      - name: Wait for Spark Connect Server to Start
        run: |
          set -e
          addr="127.0.0.1:50051"
          max_secs=240
          elapsed=0
          interval=3
          echo "Waiting for Spark Connect at $addr (timeout ${max_secs}s)..."
          while [ $elapsed -lt $max_secs ]; do
            if grpc_health_probe -addr="$addr" -tls=false >/dev/null 2>&1; then
              echo "Spark Connect server is up after ${elapsed}s"
              exit 0
            fi
            sleep $interval
            elapsed=$((elapsed+interval))
          done
          echo "Server did not become healthy within ${max_secs}s"
          echo "==== server.log (last 200 lines) ===="
          tail -n 200 tmp/spark-tests/latest/server.log || true
          echo "==== listening sockets ===="
          (command -v ss >/dev/null && ss -lntp) || (command -v lsof >/dev/null && lsof -iTCP -sTCP:LISTEN -nP) || true
          exit 1

      - name: Tail recent server log (optional)
        if: failure()
        run: |
          echo "::group::server.log (last 200 lines)"
          tail -n 200 tmp/spark-tests/latest/server.log || true
          echo "::endgroup::"


      - name: Run ibis tests
        timeout-minutes: 15
        run: |
          hatch run test-ibis:env \
            SPARK_REMOTE="${SPARK_REMOTE}" \
            scripts/spark-tests/run-tests.sh

      - name: Shutdown Spark Connect Server
        if: always()
        run: |
          # Find and kill sail server processes
          SAIL_PIDS=$(pgrep -f "sail spark server" || echo "")
          if [ -n "$SAIL_PIDS" ]; then
            echo "Found sail server processes: $SAIL_PIDS"
            # Send SIGINT for graceful shutdown
            kill -INT $SAIL_PIDS 2>/dev/null || true
            # Wait up to 30 seconds for graceful shutdown
            for i in {1..30}; do
              if ! pgrep -f "sail spark server" > /dev/null; then
                echo "Sail server stopped gracefully"
                break
              fi
              sleep 1
            done
            # Force kill if still running
            REMAINING_PIDS=$(pgrep -f "sail spark server" || echo "")
            if [ -n "$REMAINING_PIDS" ]; then
              echo "Force killing remaining processes: $REMAINING_PIDS"
              kill -KILL $REMAINING_PIDS 2>/dev/null || true
            fi
          else
            echo "No sail server processes found"
          fi
          sleep 10
