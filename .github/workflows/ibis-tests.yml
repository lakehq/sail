name: Ibis Tests

on:
  workflow_call:

jobs:
  setup:
    name: Setup
    runs-on: ubuntu-latest
    outputs:
      run_tests: ${{ ((github.event_name == 'pull_request' && (github.event.action == 'opened' || steps.match.outputs.result == 'true' || steps.label.outputs.has_label == 'true')) || github.event_name == 'push') && 'true' || 'false' }}
    steps:
      - uses: actions/checkout@v4

      - uses: ./.github/actions/commit-message-match
        id: match
        with:
          pattern: "\\[(ibis )?tests?\\]"
          ignore_case: true

      - uses: actions/github-script@v7
        id: label
        with:
          script: |
            const labels = context.payload.pull_request?.labels?.map(label => label.name) || [];
            core.setOutput('has_label', labels.includes('run ibis tests') ? 'true' : 'false');

  test:
    name: Test
    if: needs.setup.outputs.run_tests == 'true'
    runs-on: ubuntu-latest
    needs:
      - setup
    env:
      # Set the Hatch environment for `hatch run` commands.
      HATCH_ENV: "test-ibis"

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Hatch
        uses: pypa/hatch@install

      - name: Checkout ibis testing data
        uses: actions/checkout@v4
        with:
          repository: ibis-project/testing-data
          path: opt/ibis-testing-data

      - name: Download Python Package
        uses: actions/download-artifact@v4
        with:
          name: python-package
          path: target/wheels

      - name: Build native extension
        run: |
          hatch run install-pysail

      - name: Install grpc_health_probe
        run: |
          wget -q -O /usr/local/bin/grpc_health_probe "https://github.com/grpc-ecosystem/grpc-health-probe/releases/download/v0.4.26/grpc_health_probe-linux-amd64"
          chmod +x /usr/local/bin/grpc_health_probe
          grpc_health_probe -version

      - name: Run Spark Connect Server
        run: |
          nohup hatch run scripts/spark-tests/run-server.sh > /dev/null 2>&1 < /dev/null &

      - name: Wait for Spark Connect Server to Start
        run: |
          scripts/spark-tests/wait-for-server.sh

      - name: Run Ibis Tests
        # We set a timeout to prevent the tests from hanging indefinitely,
        # which can happen occasionally for unknown reasons.
        # The timeout value should be adjusted as we add more tests.
        timeout-minutes: 10
        run: |
          hatch run test-ibis:env SPARK_REMOTE="sc://localhost:50051" scripts/spark-tests/run-tests.sh || true
          echo "## ðŸ§ª Ibis Tests Summary" >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
          tail -n 1 tmp/spark-tests/ibis/test-ibis.log >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"

      - name: Shutdown Spark Connect Server
        if: always()
        run: |
          # Find and kill sail server processes
          SAIL_PIDS=$(pgrep -f "sail spark server" || echo "")
          if [ -n "$SAIL_PIDS" ]; then
            echo "Found sail server processes: $SAIL_PIDS"
            # Send SIGINT for graceful shutdown
            kill -INT $SAIL_PIDS 2>/dev/null || true
            # Wait up to 30 seconds for graceful shutdown
            for i in {1..30}; do
              if ! pgrep -f "sail spark server" > /dev/null; then
                echo "Sail server stopped gracefully"
                break
              fi
              sleep 1
            done
            # Force kill if still running
            REMAINING_PIDS=$(pgrep -f "sail spark server" || echo "")
            if [ -n "$REMAINING_PIDS" ]; then
              echo "Force killing remaining processes: $REMAINING_PIDS"
              kill -KILL $REMAINING_PIDS 2>/dev/null || true
            fi
          else
            echo "No sail server processes found"
          fi
          sleep 10
