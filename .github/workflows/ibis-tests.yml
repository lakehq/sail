name: Ibis Tests

on:
  workflow_call:
    secrets:
      CODECOV_TOKEN:
        required: false

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    env:
      # Set the Hatch environment for `hatch run` commands.
      HATCH_ENV: "test-ibis"
      RUSTC_WORKSPACE_WRAPPER: ${{ github.workspace }}/.github/scripts/rustc-workspace-wrapper.sh
      LLVM_PROFILE_FILE: ${{ github.workspace }}/target/sail-ibis-%p-%m.profraw

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Hatch
        uses: pypa/hatch@install

      - name: Install Rust toolchain and coverage tools
        run: |
          {
            rustup toolchain install stable
            rustup component add --toolchain stable llvm-tools-preview
          } &

      - name: Install grcov
        uses: taiki-e/install-action@grcov

      - name: Checkout ibis testing data
        uses: actions/checkout@v4
        with:
          repository: ibis-project/testing-data
          path: opt/ibis-testing-data

      - name: Download Python Package
        uses: actions/download-artifact@v4
        with:
          name: python-package
          path: target/wheels

      - name: Set Up Hatch Environment
        run: |
          hatch run install-pysail

      - name: List Python packages
        continue-on-error: true
        run: |
          hatch run uv pip freeze || hatch run python -m pip freeze

      - name: Install grpc_health_probe
        run: |
          wget -q -O /usr/local/bin/grpc_health_probe "https://github.com/grpc-ecosystem/grpc-health-probe/releases/download/v0.4.26/grpc_health_probe-linux-amd64"
          chmod +x /usr/local/bin/grpc_health_probe
          grpc_health_probe -version

      - name: Run Spark Connect Server
        run: |
          nohup hatch run scripts/spark-tests/run-server.sh > /dev/null 2>&1 < /dev/null &

      - name: Wait for Spark Connect Server to Start
        run: |
          scripts/spark-tests/wait-for-server.sh

      - name: Run Ibis Tests
        # We set a timeout to prevent the tests from hanging indefinitely,
        # which can happen occasionally for unknown reasons.
        # The timeout value should be adjusted as we add more tests.
        timeout-minutes: 10
        env:
          TEST_RUN_GIT_COMMIT: ${{ github.sha }}
          TEST_RUN_GIT_REF: ${{ github.ref }}
        run: |
          hatch run test-ibis:env SPARK_REMOTE="sc://localhost:50051" scripts/spark-tests/run-tests.sh || true

      - name: Shutdown Spark Connect Server
        if: ${{ !cancelled() }}
        run: |
          scripts/spark-tests/stop-server.sh

      # Generate coverage report after Ibis tests
      - name: Generate coverage report
        run: |
          # Wait for background Rust toolchain installation to complete
          wait
          BINARY_PATH=$(hatch run python -c 'import pysail._native; import os; print(os.path.dirname(pysail._native.__file__))')
          echo "Binary path: $BINARY_PATH"
          LLVM_PATH=$(.github/scripts/find-llvm-profdata.sh)
          grcov target --binary-path "$BINARY_PATH" -s . \
            --llvm-path "$LLVM_PATH" \
            -t lcov --branch --ignore-not-existing \
            -o coverage-ibis.info

      - name: Upload Ibis coverage to Codecov
        if: ${{ github.actor != 'dependabot[bot]' }}
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: coverage-ibis.info
          flags: ibis-tests
          name: ibis-tests
          fail_ci_if_error: true
          env_vars: OS

      - name: Upload Test Logs
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v4
        with:
          name: ibis-test-logs
          path: tmp/spark-tests/ibis
          retention-days: 30

  analyze:
    name: Analyze
    runs-on: ubuntu-slim
    needs:
      - test
    steps:
      - uses: actions/checkout@v4

      - uses: ./.github/actions/commit-baseline
        id: baseline

      - uses: ./.github/actions/commit-workflow
        id: baseline-workflow
        with:
          sha: ${{ steps.baseline.outputs.sha }}
          workflow_name: Build
          artifact_name: ibis-test-logs

      - name: Download Test Logs
        uses: actions/download-artifact@v4
        with:
          name: ibis-test-logs
          path: /tmp/test-after

      - name: Download Test Logs (Baseline)
        if: ${{ steps.baseline-workflow.outputs.workflow_run_id != '' }}
        uses: actions/download-artifact@v4
        with:
          name: ibis-test-logs
          path: /tmp/test-before
          run-id: ${{ steps.baseline-workflow.outputs.workflow_run_id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download Test Logs (No Baseline)
        if: ${{ steps.baseline-workflow.outputs.workflow_run_id == '' }}
        run: |
          cp -r /tmp/test-after /tmp/test-before

      - name: Generate Test Report
        env:
          TEST_REPORT_NAME: "Ibis Test Report"
          BASELINE_WORKFLOW_RUN_ID: ${{ steps.baseline-workflow.outputs.workflow_run_id }}
        run: |
          mkdir -p /tmp/report
          report="/tmp/report/report.md"
          if [[ -z "$BASELINE_WORKFLOW_RUN_ID" ]]; then
            printf "> [!WARNING]\n> The baseline was not found.\n\n" >> "$report"
          fi
          scripts/spark-tests/generate-test-report.sh /tmp/test-after /tmp/test-before >> "$report"
          cat "$report" >> "$GITHUB_STEP_SUMMARY"

      - name: Save Pull Request Number
        if: github.event_name == 'pull_request'
        env:
          NUMBER: ${{ github.event.number }}
        run: |
          echo "$NUMBER" > /tmp/report/pull-request.txt

      - name: Upload Test Report
        uses: actions/upload-artifact@v4
        with:
          name: ibis-test-report
          path: /tmp/report
          retention-days: 1
