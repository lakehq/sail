name: Run Spark tests and generate a test report
on:
  workflow_call:

jobs:
  run-current:
    uses: ./.github/workflows/run-spark-tests-internal.yml
    with:
      ref: ${{ github.ref }}
      name: current

  run-baseline:
    uses: ./.github/workflows/run-spark-tests-internal.yml
    with:
      # FIXME: use the correct ref
      # ref: ${{ github.head_ref }}
      ref: ${{ github.ref }}
      name: baseline
    # Test the baseline commit only after the current commit has been tested successfully.
    # The baseline also runs faster when the Spark environment is cached by the previous tests.
    needs:
      - run-current

  report:
    runs-on: ubuntu-latest
    needs:
      - run-current
      - run-baseline
    steps:
      - uses: actions/checkout@v4

      - name: Install jq
        run: |
          wget -q -O /usr/local/bin/jq "https://github.com/jqlang/jq/releases/download/jq-1.7.1/jq-linux-amd64"
          chmod +x /usr/local/bin/jq
          jq --version

      - name: Download current test logs
        uses: actions/download-artifact@v4
        with:
          name: test-logs-current
          path: logs/current

      - name: Download baseline test logs
        uses: actions/download-artifact@v4
        with:
          name: test-logs-baseline
          path: logs/baseline

      - name: Generate test report
        run: |
          jq -r -f scripts/spark-tests/count-errors.jq \
            --slurpfile baseline logs/baseline/test.jsonl \
            logs/current/test.jsonl
          # TODO: truncate text if too long
        shell: bash
