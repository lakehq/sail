name: Run Spark tests and generate a test report
on:
  workflow_call:

jobs:
  run:
    uses: ./.github/workflows/run-spark-tests-internal.yml
    with:
      ref: ${{ github.ref }}

  run-baseline:
    uses: ./.github/workflows/run-spark-tests-internal.yml
    with:
      ref: ${{ github.head_ref }}

  report:
    runs-on: ubuntu-latest
    steps:
      - name: Install jq
        run: |
          set -e
          cd /tmp
          wget "https://github.com/jqlang/jq/releases/download/jq-1.7.1/jq-linux-amd64"
          mv jq-linux-amd64 /usr/local/bin/jq
          chmod +x /usr/local/bin/jq
          jq --version

      - name: Download test logs
        uses: actions/download-artifact@v4
        with:
          name: test-logs-${{ github.ref }}
          path: logs/current

      - name: Download test logs for baseline
        uses: actions/download-artifact@v4
        with:
          name: test-logs-${{ github.head_ref }}
          path: logs/baseline

      - name: Generate test report
        run: |
          jq -r -f scripts/spark-tests/count-errors.jq \
            --slurpfile baseline logs/baseline/test.jsonl \
            logs/current/test.jsonl
          # TODO: truncate text if too long
        shell: bash
