name: Run Spark tests

on:
  workflow_call:
    inputs:
      head_ref:
        description: The Git head ref to run the tests on
        type: string
        required: true
      base_ref:
        description: The Git base ref to run the tests on
        type: string
        required: true
permissions:
  contents: read
  pull-requests: write

jobs:
  test-head:
    uses: ./.github/workflows/run-spark-tests-internal.yml
    with:
      ref: ${{ inputs.head_ref }}
      name: head

  test-base:
    uses: ./.github/workflows/run-spark-tests-internal.yml
    with:
      ref: ${{ inputs.base_ref }}
      name: base
    # Test the base branch only after the head branch has been tested successfully.
    # The base test also runs faster since the Spark environment is likely cached by the head test.
    needs:
      - test-head

  report:
    runs-on: ubuntu-latest
    needs:
      - test-head
      - test-base
    steps:
      - uses: actions/checkout@v4

      - name: Install jq
        run: |
          wget -q -O /usr/local/bin/jq "https://github.com/jqlang/jq/releases/download/jq-1.7.1/jq-linux-amd64"
          chmod +x /usr/local/bin/jq
          jq --version

      - name: Download head test logs
        uses: actions/download-artifact@v4
        with:
          name: test-logs-head
          path: /tmp/test-head

      - name: Download base test logs
        uses: actions/download-artifact@v4
        with:
          name: test-logs-base
          path: /tmp/test-base

      - name: Generate test report
        run: |
          scripts/spark-tests/generate-test-report.sh \
          /tmp/test-head /tmp/test-base \
          > /tmp/test-report.md
          cat /tmp/test-report.md >> "$GITHUB_STEP_SUMMARY"

      - name: Publish test report
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: spark-test-report
          path: /tmp/test-report.md
